From 64d85291fd117d16fa53ef72ebb4e86cdc97cc54 Mon Sep 17 00:00:00 2001
From: eyedeekay <idk@mulder>
Date: Wed, 7 Feb 2024 11:44:43 -0500
Subject: [PATCH 03/18] Disable use of sysinfo.h on Mac OSX and replace
 deprecated functions that killed it

---
 src/libsam3a/libsam3a.c | 34 +++++++++++++++++++++++-----------
 1 file changed, 23 insertions(+), 11 deletions(-)

diff --git src/libsam3a/libsam3a.c src/libsam3a/libsam3a.c
index e812f00..778f2d3 100644
--- src/libsam3a/libsam3a.c
+++ src/libsam3a/libsam3a.c
@@ -48,15 +48,27 @@
 #endif
 #endif
 
-#if defined(__unix__) || defined(__APPLE__)
+#if defined(__unix__) || !defined(__APPLE__)
+#include <sys/sysinfo.h>
+#endif
+
+#if defined(__unix__)
 #include <arpa/inet.h>
 #include <netdb.h>
 #include <netinet/in.h>
 #include <sys/ioctl.h>
 #include <sys/socket.h>
-#include <sys/sysinfo.h>
 #include <sys/types.h>
 #endif
+
+#if defined(__APPLE__)
+uint32_t TickCount() {
+  uint64_t mat = mach_absolute_time();
+  uint32_t mul = 0x80d9594e;
+  return ((((0xffffffff & mat) * mul) >> 32) + (mat >> 32) * mul) >> 23;
+}
+#endif
+
 ////////////////////////////////////////////////////////////////////////////////
 int libsam3a_debug = 0;
 
@@ -666,16 +678,16 @@ static uint32_t genSeed(void) {
   uint32_t res;
 #ifndef WIN32
   #ifndef __APPLE__
-  struct sysinfo sy;
-  pid_t pid = getpid();
-  //
-  sysinfo(&sy);
-  res = hashint((uint32_t)pid) ^ hashint((uint32_t)time(NULL)) ^
-        hashint((uint32_t)sy.sharedram) ^ hashint((uint32_t)sy.bufferram) ^
-        hashint((uint32_t)sy.uptime);
+    struct sysinfo sy;
+    pid_t pid = getpid();
+    //
+    sysinfo(&sy);
+    res = hashint((uint32_t)pid) ^ hashint((uint32_t)time(NULL)) ^
+          hashint((uint32_t)sy.sharedram) ^ hashint((uint32_t)sy.bufferram) ^
+          hashint((uint32_t)sy.uptime);
   #else
-  res = hashint((uint32_t)GetCurrentProcessId()) ^
-        hashint((uint32_t)GetTickCount());
+    res = hashint((uint32_t)getpid()) ^
+          hashint((uint32_t)TickCount());
   #endif
 #else
   res = hashint((uint32_t)GetCurrentProcessId()) ^
-- 
2.43.1

