# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               ocaml 1.1
PortGroup               github 1.0

github.setup            stan-dev stanc3 2.30.1 v
revision                0
categories              math lang ocaml
maintainers             {@barracuda156 gmail.com:vital.had} {@catap korins.ky:kirill} openmaintainer
license                 BSD-3-Clause
description             New compiler for Stan, written in OCaml
long_description        ${description}
homepage                https://mc-stan.org/stanc3/stanc
checksums               rmd160  368bb8b6c92e04c6dd1c6a37240e34371d790f05 \
                        sha256  e5e0fbae731186135ded19d30a79d5c538c81cc294a996b8f06686eacb96392c \
                        size    15007425

depends_lib-append      port:ocaml-core \
                        port:ocaml-core_unix \
                        port:ocaml-fmt \
                        port:ocaml-menhir \
                        port:ocaml-ppx_deriving \
                        port:ocaml-ppx_jane \
                        port:ocaml-re \
                        port:ocaml-yojson

# Presently ocaml-patdiff does not build due to ocaml-expect_test_helpers being incompatible with new ppxlib.
# Status of the rest is unknown.
# However, tests are broken themselves for the same reason, see: https://github.com/stan-dev/stanc3/issues/1272
# This is why code is broken with OCaml, for example: https://blog.janestreet.com/goodbye-Core_kernel
# ocaml-bisect_ppx is optional, but broken: https://github.com/aantron/bisect_ppx/pull/400
# depends_test-append     port:ocaml-bisect_ppx \
#                         port:ocaml-merlin \
#                         port:ocaml-ocamlformat \
#                         port:ocaml-ocp-indent \
#                         port:ocaml-patdiff \
#                         port:ocaml-utop

# Importantly, there does not seem to be a properly set target in order not to build the tests.
# An ugly but functional workaround: DELETE TESTS FOLDER prior to build. We can implement it in portfile, but why?

# Without tests Stanc should build. Confirmed with OCaml 4.14 and my dependencies.

ocaml.build_type        dune
dune.packages           stanc
