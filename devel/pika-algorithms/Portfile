# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           boost 1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           mpi 1.0

# Keep in sync with Pika:
boost.version       1.81

github.setup        pika-org pika-algorithms 0.1.4
revision            0
categories          devel parallel
platforms           {darwin any}
license             Boost-1
maintainers         {@barracuda156 gmail.com:vital.had} openmaintainer
description         ${name} is a C++ library containing parallel algorithms built on top of pika
long_description    {*}${description}
checksums           rmd160  1063dd5aac28ff6d3e803205a80324abe1901b8a \
                    sha256  67ea5e8545b234f82dcc75612a774f2e3df8425a283f2034c2d1e2e5ac74f945 \
                    size    832806
github.tarball_from archive
supported_archs     noarch

set port_libfmt libfmt10
cmake.module_path-append \
                    ${prefix}/lib/${port_libfmt}/cmake

depends_build-append \
                    port:git
depends_lib-append  port:hwloc \
                    port:${port_libfmt} \
                    port:pika

if {${os.platform} eq "darwin" && ${os.arch} eq "powerpc"} {
    mpi.setup       require -gcc6 -gcc7 -gcc8 -clang -fortran
} else {
    mpi.setup       require -gcc6 -gcc7 -gcc8
}

compiler.thread_local_storage yes
compiler.cxx_standard 2017
# Follow Pika:
compiler.blacklist-append \
                    {clang < 1300} {macports-clang-[4-6].0}

configure.args-append \
                    -DPIKA_ALGORITHMS_WITH_TESTS_BENCHMARKS=OFF \
                    -DPIKA_ALGORITHMS_WITH_EXAMPLES=OFF \
                    -DPIKA_ALGORITHMS_WITH_TESTS_REGRESSIONS=OFF \
                    -DPIKA_ALGORITHMS_WITH_TESTS=OFF \
                    -DPIKA_ALGORITHMS_WITH_TESTS_EXAMPLES=OFF \
                    -DPIKA_ALGORITHMS_WITH_TESTS_HEADERS=OFF \
                    -DPIKA_ALGORITHMS_WITH_TESTS_UNIT=OFF

variant tests description "Enable testing" {
    # Large number of test fail simply due to wrong paths to includes: https://github.com/pika-org/pika-algorithms/issues/24
    # However this is for upstream to fix, since they have changed header layout in a non-trivial way.
    configure.pre_args-replace \
                    -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=ON \
                    -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=OFF
    configure.args-replace \
                    -DPIKA_ALGORITHMS_WITH_TESTS=OFF -DPIKA_ALGORITHMS_WITH_TESTS=ON \
                    -DPIKA_ALGORITHMS_WITH_TESTS_HEADERS=OFF -DPIKA_ALGORITHMS_WITH_TESTS_HEADERS=ON
    configure.args-append \
                    -DPIKA_ALGORITHMS_WITH_TESTS_MAX_THREADS=${buildmakejobs}
    test.run        yes
    test.cmd        ctest
}

variant jemalloc description "Use jemalloc instead of system malloc" {
    depends_lib-append \
                    port:jemalloc
    require_active_variants \
                    port:pika jemalloc
}
