From a1b915142382937933799c850fc73809c17cebab Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Sun, 30 Jun 2024 22:58:26 +0800
Subject: [PATCH 11/11] mono-mmap.c: restore correct behavior of MAP_32BIT on
 Apple

Reverts changes introduced by: https://github.com/mono/mono/commit/2f2771fcfa22ac16a24a6a1ff2554440e5de29ca
See also the original: https://github.com/mono/mono/commit/e64c78439605d6da65f306710769a8dd88fa013b

---
 mono/utils/mono-mmap.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/mono/utils/mono-mmap.c b/mono/utils/mono-mmap.c
index 2484163e9cf..aa99b8e4ecc 100644
--- a/mono/utils/mono-mmap.c
+++ b/mono/utils/mono-mmap.c
@@ -30,6 +30,10 @@
 #include <errno.h>
 #endif /* !HOST_WIN32 */
 
+#if defined(__APPLE__)
+#include <AvailabilityMacros.h>
+#endif
+
 #include "mono-mmap.h"
 #include "mono-mmap-internals.h"
 #include "mono-proclib.h"
@@ -49,7 +53,7 @@
 #define MAP_ANONYMOUS MAP_ANON
 #endif
 
-#if !defined(__APPLE__)  // returning virtual addresses <4G requires entitlement on Apple platforms, do not use it
+#if !defined(__APPLE__) || MAC_OS_X_VERSION_MIN_REQUIRED < 101500  // returning virtual addresses <4G requires entitlement on Apple platforms, do not use it
 #ifndef MAP_32BIT
 #define MAP_32BIT 0
 #endif
@@ -278,7 +282,7 @@ mono_valloc (void *addr, size_t length, int flags, MonoMemAccountType type)
 	/* translate the flags */
 	if (flags & MONO_MMAP_FIXED)
 		mflags |= MAP_FIXED;
-#if !defined(__APPLE__)  // returning virtual addresses <4G requires entitlement on Apple platforms, do not use it
+#if !defined(__APPLE__) || MAC_OS_X_VERSION_MIN_REQUIRED < 101500 // returning virtual addresses <4G requires entitlement on Apple platforms, do not use it
 	if (flags & MONO_MMAP_32BIT)
 		mflags |= MAP_32BIT;
 #endif
@@ -390,7 +394,7 @@ mono_file_map_error (size_t length, int flags, int fd, guint64 offset, void **re
 		mflags |= MAP_SHARED;
 	if (flags & MONO_MMAP_FIXED)
 		mflags |= MAP_FIXED;
-#if !defined(__APPLE__)  // returning virtual addresses <4G requires entitlement on Apple platforms, do not use it
+#if !defined(__APPLE__) || MAC_OS_X_VERSION_MIN_REQUIRED < 101500 // returning virtual addresses <4G requires entitlement on Apple platforms, do not use it
 	if (flags & MONO_MMAP_32BIT)
 		mflags |= MAP_32BIT;
 #endif
