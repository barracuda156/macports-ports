From e50ed6323f494f7204e3fa650e3da8bd74f9065c Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 5 May 2023 12:48:06 +0800
Subject: [PATCH 2/9] utils/mono-threads-mach.c: fix for missing
 pthread_threadid_np

---
 mono/utils/mono-threads-mach.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git mono/utils/mono-threads-mach.c mono/utils/mono-threads-mach.c
index a9240dd36de..604114ab816 100644
--- mono/utils/mono-threads-mach.c
+++ mono/utils/mono-threads-mach.c
@@ -15,6 +15,10 @@
 #define _DARWIN_C_SOURCE 1
 #endif
 
+#if defined __APPLE__
+#include <AvailabilityMacros.h>
+#endif
+
 #include <mono/utils/mono-threads.h>
 #include <mono/utils/mono-mmap.h>
 
@@ -283,7 +287,17 @@ guint64
 mono_native_thread_os_id_get (void)
 {
 	uint64_t tid;
+#if (MAC_OS_X_VERSION_MAX_ALLOWED < 1060) || defined(__POWERPC__)
+	tid = pthread_mach_thread_np (pthread_self ());
+#elif elif MAC_OS_X_VERSION_MIN_REQUIRED < 1060
+	if (&pthread_threadid_np) {
+		pthread_threadid_np (pthread_self (), &tid);
+	} else {
+		tid = pthread_mach_thread_np (pthread_self ());
+	}
+#else
 	pthread_threadid_np (pthread_self (), &tid);
+#endif
 	return tid;
 }
 
-- 
2.40.1

