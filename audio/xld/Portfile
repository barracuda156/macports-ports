# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                xld
version             20230416
revision            0

categories          audio
supported_archs     x86_64 arm64 i386 ppc
license             GPL-2
maintainers         {judaew @judaew} openmaintainer

description         Lossless audio decoder for Mac OS X
long_description    \
    X Lossless Decoder(XLD) is a tool for Mac OS X that is able to \
    decode/convert/play various 'lossless' audio files. The supported audio \
    files can be split into some tracks with cue sheet when decoding. It works \
    on Mac OS X 10.4 and later.
homepage            https://tmkk.undo.jp/xld/index_e.html

if {![variant_isset prebuilt]} {
    PortGroup       xcode 1.0

    maintainers     {judaew @judaew} {@barracuda156 gmail.com:vital.had} openmaintainer
    fetch.type      svn
    svn.url         https://svn.code.sf.net/p/xld/code/trunk
    svn.revision    r617
    worksrcdir      trunk

    xcode.project   "XLD/XLD_export.xcodeproj"

    depends_lib-append \
                    port:flac \
                    port:libcddb \
                    port:libebur128 \
                    port:libsndfile \
                    port:monkeys-audio \
                    port:soxr \
                    port:wavpack

#     post-extract {
#         move ${workpath}/trunk/XLDID3 ${worksrcpath}/XLDID3.framework
#     	foreach f { XLDOpusOutput XLDTakDecoder XLDShortenDecoder XLDSparkleUpdater XLDWavpackOutput XLDHEAACOutput XLDAacOutput2 XLDFlacDecoder XLDFlacOutput \
# 		    XLDAlacOutput XLDApeDecoder XLDLameOutput XLDAacOutput XLDVorbisOutput XLDTtaDecoder XLDWavpackDecoder XLDAlacDecoder XLDLibsndfileDecoder XLDMP3Decoder } {
# 		            move ${workpath}/trunk/${f} ${worksrcpath}/${f}.bundle
# 		}
#     }

    patchfiles      patch-project.diff \
                    patch-XLD.diff

    post-patch {
        reinplace "s,@PREFIX@,${prefix},g" ${worksrcpath}/XLD/XLD_export.xcodeproj/project.pbxproj
    }

    build {
        set xcode_configuration_arg [xcode::get_configuration_arg ${xcode.configuration}]
        set xcode_build_args [xcode::get_build_args]
        foreach dir {XLDOpusOutput XLDTakDecoder XLDShortenDecoder XLDSparkleUpdater XLDWavpackOutput XLDHEAACOutput XLDAacOutput2 XLDFlacDecoder XLDFlacOutput \
 		    XLDAlacOutput XLDApeDecoder XLDLameOutput XLDAacOutput XLDVorbisOutput XLDTtaDecoder XLDWavpackDecoder XLDAlacDecoder XLDLibsndfileDecoder XLDMP3Decoder XLD} {
            build.dir ${worksrcpath}/${dir}
            xcode::build_one_target "-target \"${dir}\" ${xcode_configuration_arg}" \
                "${xcode_build_args} ${xcode.build.settings}"
        }
    }

    xcode.build.settings \
                    LIBRARY_SEARCH_PATHS=${prefix}/lib
    xcode.destroot.settings \
                    LIBRARY_SEARCH_PATHS=${prefix}/lib
}

variant prebuilt description "Install prebuilt app" {
    maintainers     {judaew @judaew} openmaintainer
    master_sites    sourceforge:xld
    distname        xld-${version}
    use_dmg         yes

    checksums       rmd160  46f76b806f523d7081a1ebc5ebe1746ce61bba57 \
                    sha256  264e34bd90bea1cb5c7fc2756675c9c714d4907c85d959ea219268c0d455589a \
                    size    11140995

    variant universal   {}
    default_variants    +universal

    use_configure   no
    build {}

    patchfiles      patch-use-macports-applications-dir.diff

    post-patch {
        reinplace "s,@@APPLICATIONS_DIR@@,${applications_dir},g" \
            ${worksrcpath}/CLI/xld
    }

    destroot {
        move ${worksrcpath}/XLD.app ${destroot}${applications_dir}
        xinstall -m 0755 ${worksrcpath}/CLI/${name} ${destroot}${prefix}/bin
    }
}
