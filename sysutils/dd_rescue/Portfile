# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           makefile 1.0
PortGroup           openssl 1.0

openssl.branch      1.1

name                dd_rescue
version             1.99.13
categories          sysutils
maintainers         nomaintainer
description         copy data from one file or block device to another
long_description    dd_rescue is modeled after dd but optimized for copying \
                    data from possible damaged disks to your system
license             {GPL-2 GPL-3}
homepage            http://www.garloff.de/kurt/linux/ddrescue \
                    https://sourceforge.net/projects/ddrescue
master_sites        ${homepage}
checksums           rmd160  56cccf9d67eb7dc6108d3192e98ba5123b1c9d3d \
                    sha256  f40fe9c770ff5d27d323297ee73d0bbed332d3eafac4e4732e542eadb1c5c1e8 \
                    size    182574
use_bzip2           yes
extract.rename      yes

depends_build-append \
                    port:autoconf \
                    port:automake \
                    port:libtool

set py_ver          3.11
set py_ver_nodot    [string map {. {}} ${py_ver}]
depends_test-append path:libexec/coreutils/libstdbuf.so:coreutils \
                    port:python${py_ver_nodot}

configure.python    ${prefix}/bin/python${py_ver}

# The source code is pretty broken, so patches are extensive.
patchfiles          patch-Makefile.diff \
                    patch-fix-includes.diff \
                    patch-fix-endian.diff \
                    patch-test-scripts.diff \
                    patch-skip-broken-source.diff

platform darwin powerpc {
    # FIXME: test_aes fails on PowerPC at the moment; we want to run the rest of tests however.
    # Encrypt: Assertion failed: (ectx->cipher_data == EVP_CIPHER_CTX_get_cipher_data(*evpctx)),
    # function AES_OSSL_Recycle, file aes_ossl11.c, line 83.
    # ./test_crypt.sh: line 66: 27470 Abort trap $VG ./test_aes -s -w AES128-CTR 50000 0 15392
    patchfiles-append \
                    patch-skip-test_aes-ppc.diff
}

post-patch {
    reinplace "s,@PREFIX@,${prefix},g" ${worksrcpath}/Makefile
    reinplace "s,@CC@,${configure.cc}," ${worksrcpath}/Makefile
    reinplace "s,@ARCHFLAGS@,[get_canonical_archflags],g" ${worksrcpath}/Makefile
    reinplace "s,/usr/bin/env python3,${configure.python}," ${worksrcpath}/calchmac.py
}

compiler.c_standard 2011

# default target builds bintargets and libtargets, all adds other targets to default.
build.target        all

use_parallel_build  no

test.cmd-prepend    PATH=${prefix}/libexec/gnubin:${prefix}/libexec/openssl11/bin:${prefix}/bin:/usr/bin:/bin
test.run            yes
test.target         check
